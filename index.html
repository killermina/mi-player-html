<!DOCTYPE html>
<html>
<head>
    <title>Shaka Player Debug</title>
    <meta charset="utf-8" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.14.10/dist/shaka-player.ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/shaka-player@4.14.10/dist/controls.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>

    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: black;
            display: flex; justify-content: center; align-items: center;
        }
        video {
            width: 100%; height: 100%; object-fit: contain; background-color: black;
        }
    </style>
</head>
<body>
    <video autoplay muted controls data-shaka-player id="youtube-theme"></video>

    <script type="text/javascript">
        function logToKodular(message) {
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString(message);
            } else {
                console.log("Kodular Debug: " + message);
            }
        }

        const youtube_theme_manifestUri = 'https://opchannel01.tigosports.com.py/VMX4_widevine/rolling-buffer/TigoSportsHD/TigoSportsHD/transmux/master.mpd?dvr_window_length=30';

        async function init() {
            logToKodular('HTML Minimal cargado. Iniciando Shaka Player...');
            shaka.polyfill.installAll();
            logToKodular('Polyfills instalados.');

            const video = document.getElementById('youtube-theme');
            if (!video) {
                logToKodular('ERROR: Elemento de video no encontrado.'); return;
            }
            logToKodular('Elemento de video obtenido.');

            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();

            player.configure({
                drm: {
                    clearKeys: {
                        "b52a7fa91fb031a3d6f2a505414b6fcd": "a655a22f9c0a66574b5d95dee212fbf9" ,
                    }
                }
            });
            logToKodular('DRM (Clear Keys) aplicado.');

            player.addEventListener('error', onPlayerErrorEvent);
            controls.addEventListener('error', onUIErrorEvent);

            try {
                logToKodular('Intentando cargar manifiesto: ' + youtube_theme_manifestUri);
                await player.load(youtube_theme_manifestUri);
                logToKodular('Manifiesto cargado con éxito!');

                // Auto-play con muted, luego intentar desmutear con interacción de usuario
                if (video.paused || video.muted) {
                    // Si se queda en blanco, probaremos sin el play() inicial
                    // try { await video.play(); logToKodular('Video.play() inicial llamado.'); } catch (e) { logToKodular('Autoplay inicial bloqueado: ' + e.message); }
                }

            } catch (error) {
                onPlayerError(error);
                logToKodular('ERROR FATAL al cargar video: ' + error.code + ', ' + error.message);
            }
        }

        function onPlayerErrorEvent(errorEvent) { onPlayerError(errorEvent.detail); }
        function onPlayerError(error) { console.error('Shaka Player Error:', error); logToKodular('Shaka Error: ' + (error.code || 'N/A') + ', ' + (error.message || 'N/A')); }
        function onUIErrorEvent(errorEvent) { onPlayerError(errorEvent.detail); }
        function initFailed(errorEvent) { console.error('UI load failed!', errorEvent); logToKodular('Shaka UI Load Failed!'); }

        document.addEventListener('shaka-ui-loaded', init);
        document.addEventListener('shaka-ui-load-failed', initFailed);

        // Puedes mantener las funciones de control de Kodular (muteVideo, unmuteVideo, playVideo, pauseVideo)
        // si quieres llamarlas manualmente desde Kodular.
        // Por ejemplo, para desmutear después de que la página cargue:
        window.unmuteVideo = function() {
            const video = document.getElementById('youtube-theme');
            if (video) {
                video.muted = false;
                video.play().then(() => {
                    logToKodular('Video desmuteado y reproduciendo por JS.');
                }).catch(e => {
                    logToKodular('Fallo desmuteo/play por JS: ' + e.message);
                });
            }
        };
    </script>
</body>
</html>
